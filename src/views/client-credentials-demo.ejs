<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Client Credentials Flow Demo</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; }
      button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
      button:hover { background: #0056b3; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
      .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
      .status.success { background: #d4edda; }
      .status.error { background: #f8d7da; }
      .status.info { background: #d1ecf1; }
    </style>
  </head>
  <body>
    <h1>Client Credentials Flow Demo</h1>
    <p class="status info">This flow is for machine-to-machine communication. No user interaction required!</p>
    <p class="status" style="background: #d1ecf1; border: 1px solid #0c5460; color: #0c5460; margin: 15px 0;">
      <strong>‚ÑπÔ∏è Endpoint:</strong> This flow uses the UMS endpoint (<code>/auth/v1/oauth-apps/token</code>) instead of Hydra. The token's <code>sub</code> claim will be set to the <code>owner_identity_id</code>.
    </p>
    
    <div class="card">
      <h2>Step 1: Request Access Token</h2>
      <p>Click the button below to get an access token using only client credentials:</p>
      <p><strong>Client Scopes:</strong> <code><%= clientScopes || "openid offline" %></code></p>
      <p style="font-size: 0.9em; color: #666;">üí° <strong>Note:</strong> These scopes are from your client configuration. Update the client's scope in the <a href="/clients">Client Management</a> page and refresh this page to use new scopes.</p>
      <button id="requestTokenBtn" onclick="requestToken()">Get Access Token</button>
      <div id="tokenResult"></div>
    </div>
    
    <div class="card" id="apiTestCard" style="display: none;">
      <h2>Step 2: Test API Call</h2>
      <p>Now let's test the API with the access token:</p>
      <button id="testApiBtn" onclick="testAPI()">Test API Call</button>
      <div id="apiResult"></div>
    </div>
    
    <div class="card" id="successCard" style="display: none;">
      <h2>‚úÖ Success!</h2>
      <div id="successContent"></div>
    </div>
    
    <script>
      let accessToken = '';
      const CLIENT_ID = '<%= clientId %>';
      const CLIENT_SECRET = '<%= clientSecret %>';
      const CLIENT_SCOPES = '<%= clientScopes || "openid offline" %>';
      
      async function requestToken() {
        const btn = document.getElementById('requestTokenBtn');
        btn.disabled = true;
        btn.textContent = 'Requesting...';
        
        try {
          const response = await fetch('/client-credentials/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              client_id: CLIENT_ID,
              client_secret: CLIENT_SECRET,
              scope: CLIENT_SCOPES
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            const errorMsg = data.error_description || data.error || 'Failed to get access token';
            const errorDetails = JSON.stringify(data, null, 2);
            throw new Error(errorMsg + ' Details: ' + errorDetails);
          }
          
          accessToken = data.access_token;
          
          document.getElementById('tokenResult').innerHTML = 
            '<div class="status success">‚úì Access token received!</div>' +
            '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
          
          document.getElementById('apiTestCard').style.display = 'block';
          
        } catch (error) {
          document.getElementById('tokenResult').innerHTML = 
            '<div class="status error">Error: ' + error.message + '</div>';
        } finally {
          btn.disabled = false;
          btn.textContent = 'Get Access Token';
        }
      }
      
      async function testAPI() {
        const btn = document.getElementById('testApiBtn');
        btn.disabled = true;
        btn.textContent = 'Testing...';
        
        try {
          const response = await fetch('/client-credentials/test-api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              access_token: accessToken
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            let tokenInfoHtml = '';
            if (data.tokenInfo) {
              const subValue = data.tokenInfo.subject || data.tokenInfo.clientId || 'N/A';
              const subNote = subValue === data.tokenInfo.clientId ? 
                '<p style="font-size: 0.85em; color: #28a745; margin-top: 5px;">‚úÖ <strong>Correct:</strong> In Client Credentials flow, <code>sub</code> should be the client ID (not a user identity).</p>' :
                '<p style="font-size: 0.85em; color: #ffc107; margin-top: 5px;">‚ö†Ô∏è <strong>Note:</strong> <code>sub</code> differs from <code>client_id</code>. In Client Credentials flow, they should match.</p>';
              
              tokenInfoHtml = '<div class="card" style="margin-top: 15px; background: #f8f9fa;"><h3>Token Information (from JWT):</h3>' +
                '<p><strong>Scopes:</strong> <code>' + (data.tokenInfo.scopes || 'N/A') + '</code></p>' +
                '<p><strong>Audience:</strong> <code>' + (typeof data.tokenInfo.audience === 'object' ? JSON.stringify(data.tokenInfo.audience) : data.tokenInfo.audience) + '</code></p>' +
                '<p><strong>Subject (sub):</strong> <code>' + subValue + '</code></p>' +
                '<p><strong>Client ID (from token):</strong> <code>' + (data.tokenInfo.clientId || 'N/A') + '</code></p>' +
                subNote +
                '<p><strong>Expires At:</strong> <code>' + (data.tokenInfo.expiresAt || 'N/A') + '</code></p>' +
                '</div>';
            }
            
            document.getElementById('apiResult').innerHTML = 
              '<div class="status success">‚úÖ External API call successful! Authentication is working.</div>' +
              '<p><strong>External API:</strong> ' + (data.apiUrl || 'https://api.dev.workstream.us/hris/v1/jobs') + '</p>' +
              '<p><strong>Response Time:</strong> ' + (data.duration || 'N/A') + '</p>' +
              tokenInfoHtml +
              '<details><summary>API Response</summary><pre>' + JSON.stringify(data.data, null, 2) + '</pre></details>';
            
            document.getElementById('successCard').style.display = 'block';
            let curlCommandsHtml = '';
            if (data.curlCommand) {
              curlCommandsHtml += '<h3>cURL Command (Direct API Call):</h3>' +
                '<pre>' + data.curlCommand + '</pre>';
            }
            if (data.testApiCurlCommand) {
              curlCommandsHtml += '<h3>cURL Command (via Test API Endpoint):</h3>' +
                '<pre>' + data.testApiCurlCommand + '</pre>';
            }
            
            document.getElementById('successContent').innerHTML = 
              '<p><strong>Status:</strong> ' + data.status + ' ' + data.statusText + '</p>' +
              '<p><strong>External API:</strong> ' + (data.apiUrl || 'https://api.dev.workstream.us/hris/v1/jobs') + '</p>' +
              '<p><strong>Result:</strong> Client Credentials flow is working correctly!</p>' +
              curlCommandsHtml;
          } else {
            let errorMsg = '‚ùå External API call failed: ' + (data.error || 'Unknown error');
            if (data.status === 401) {
              errorMsg += '<br><br>üí° <strong>Important:</strong> The external API call WAS made from the server to <code>' + (data.apiUrl || 'https://api.dev.workstream.us/hris/v1/jobs') + '</code>, but returned 401 Unauthorized.';
              errorMsg += '<br><br><strong>Possible reasons:</strong><ul style="margin-top: 10px;"><li>Token scopes may not match what the API requires</li><li>Token audience may not include the API endpoint</li><li>API may require additional permissions/claims</li></ul>';
            } else {
              errorMsg += '<br><br>üí° <strong>Note:</strong> The server made an external API call to <code>' + (data.apiUrl || 'https://api.dev.workstream.us/hris/v1/jobs') + '</code>. You won\'t see this call in the browser\'s Network tab because it happens server-side.';
            }
            
            let tokenInfoHtml = '';
            if (data.tokenInfo) {
              const subValue = data.tokenInfo.subject || data.tokenInfo.clientId || 'N/A';
              const subNote = subValue === data.tokenInfo.clientId ? 
                '<p style="font-size: 0.85em; color: #28a745; margin-top: 5px;">‚úÖ <strong>Correct:</strong> In Client Credentials flow, <code>sub</code> should be the client ID (not a user identity).</p>' :
                '<p style="font-size: 0.85em; color: #ffc107; margin-top: 5px;">‚ö†Ô∏è <strong>Note:</strong> <code>sub</code> differs from <code>client_id</code>. In Client Credentials flow, they should match.</p>';
              
              tokenInfoHtml = '<div class="card" style="margin-top: 15px; background: #f8f9fa;"><h3>Token Information (from JWT):</h3>' +
                '<p><strong>Scopes:</strong> <code>' + (data.tokenInfo.scopes || 'N/A') + '</code></p>' +
                '<p><strong>Audience:</strong> <code>' + (typeof data.tokenInfo.audience === 'object' ? JSON.stringify(data.tokenInfo.audience) : data.tokenInfo.audience) + '</code></p>' +
                '<p><strong>Subject (sub):</strong> <code>' + subValue + '</code></p>' +
                '<p><strong>Client ID (from token):</strong> <code>' + (data.tokenInfo.clientId || 'N/A') + '</code></p>' +
                subNote +
                '<p><strong>Expires At:</strong> <code>' + (data.tokenInfo.expiresAt || 'N/A') + '</code></p>' +
                '<p><strong>Issued At:</strong> <code>' + (data.tokenInfo.issuedAt || 'N/A') + '</code></p>' +
                '</div>';
            }
            
            let curlCommandsHtml = '';
            if (data.curlCommand) {
              curlCommandsHtml += '<h3>cURL Command (Direct API Call):</h3>' +
                '<pre>' + data.curlCommand + '</pre>';
            }
            if (data.testApiCurlCommand) {
              curlCommandsHtml += '<h3>cURL Command (via Test API Endpoint):</h3>' +
                '<pre>' + data.testApiCurlCommand + '</pre>';
            }
            
            document.getElementById('apiResult').innerHTML = 
              '<div class="status error">' + errorMsg + '</div>' +
              '<p><strong>External API:</strong> ' + (data.apiUrl || 'https://api.dev.workstream.us/hris/v1/jobs') + '</p>' +
              '<p><strong>Status:</strong> ' + data.status + ' ' + data.statusText + '</p>' +
              '<p><strong>Response Time:</strong> ' + (data.duration || 'N/A') + '</p>' +
              tokenInfoHtml +
              curlCommandsHtml +
              (data.errorMessage ? '<p><strong>Error:</strong> ' + data.errorMessage + '</p>' : '') +
              (data.errorDetails ? '<details><summary>API Response Details</summary><pre>' + data.errorDetails + '</pre></details>' : '');
          }
        } catch (error) {
          document.getElementById('apiResult').innerHTML = 
            '<div class="status error">Error: ' + error.message + '</div>';
        } finally {
          btn.disabled = false;
          btn.textContent = 'Test API Call';
        }
      }
    </script>
  </body>
</html>

