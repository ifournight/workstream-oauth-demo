<!DOCTYPE html>
<html>
  <head>
    <title>OAuth Client Management</title>
    <style>
      * { box-sizing: border-box; }
      body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
      .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; }
      .btn:hover { background: #0056b3; }
      .btn-danger { background: #dc3545; }
      .btn-danger:hover { background: #c82333; }
      .btn-success { background: #28a745; }
      .btn-success:hover { background: #218838; }
      .btn-secondary { background: #6c757d; }
      .btn-secondary:hover { background: #5a6268; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; }
      table { width: 100%; border-collapse: collapse; margin-top: 20px; }
      th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
      th { background: #f8f9fa; font-weight: 600; }
      tr:hover { background: #f8f9fa; }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; font-weight: 500; }
      input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
      textarea { resize: vertical; min-height: 80px; }
      .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
      .checkbox-item { display: flex; align-items: center; gap: 5px; }
      .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
      .status.success { background: #d4edda; color: #155724; }
      .status.error { background: #f8d7da; color: #721c24; }
      .status.info { background: #d1ecf1; color: #0c5460; }
      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
      .modal-content { background: white; margin: 50px auto; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 90vh; overflow-y: auto; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
      .close:hover { color: #000; }
      .actions { display: flex; gap: 10px; }
      .code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 12px; }
      .secret { font-family: monospace; color: #dc3545; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>OAuth Client Management</h1>
      <div>
        <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
        <button class="btn btn-success" onclick="openCreateModal()" id="createClientBtn">+ Create Client</button>
      </div>
    </div>

    <div id="statusMessage"></div>

    <div class="card">
      <h2>Management Mode</h2>
      <div class="form-group">
        <label>
          <input type="radio" name="managementMode" value="global" checked onchange="switchMode()">
          Global Clients (Hydra) - All clients in Hydra
        </label>
        <br>
        <label>
          <input type="radio" name="managementMode" value="identity" onchange="switchMode()">
          Identity-Specific Clients (UMS) - Clients for a specific identity
        </label>
      </div>
      <div id="identityIdInput" style="display: none; margin-top: 15px;">
        <label for="identityId">Identity ID (owner_identity_id):</label>
        <input type="text" id="identityId" placeholder="Enter identity UUID" style="width: 100%; max-width: 400px;">
        <button class="btn" onclick="loadClients()" style="margin-left: 10px;">Load Clients</button>
      </div>
    </div>

    <div class="card">
      <h2>OAuth Clients</h2>
      <div id="clientsList">
        <p>Loading clients...</p>
      </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="clientModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Create Client</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="clientForm" onsubmit="saveClient(event)">
          <input type="hidden" id="clientId" name="client_id">
          
          <div class="form-group">
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" name="client_name" required>
          </div>

          <div class="form-group">
            <label>Grant Types</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="gt_auth_code" value="authorization_code">
                <label for="gt_auth_code">Authorization Code</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="gt_device_code" value="urn:ietf:params:oauth:grant-type:device_code">
                <label for="gt_device_code">Device Code</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="gt_client_credentials" value="client_credentials" checked>
                <label for="gt_client_credentials">Client Credentials</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="gt_refresh_token" value="refresh_token">
                <label for="gt_refresh_token">Refresh Token</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Response Types</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="rt_code" value="code" checked>
                <label for="rt_code">Code</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="scope">Scopes (space-separated)</label>
            <input type="text" id="scope" name="scope" value="openid offline" placeholder="openid offline">
          </div>

          <div class="form-group">
            <label for="redirectUris">Redirect URIs (one per line)</label>
            <textarea id="redirectUris" name="redirect_uris" placeholder="http://localhost:3000/callback"></textarea>
          </div>

          <div class="form-group">
            <label for="tokenEndpointAuthMethod">Token Endpoint Auth Method</label>
            <select id="tokenEndpointAuthMethod" name="token_endpoint_auth_method">
              <option value="client_secret_post" selected>client_secret_post</option>
              <option value="client_secret_basic">client_secret_basic</option>
              <option value="none">none</option>
            </select>
          </div>

          <div class="form-group" id="ownerIdentityIdGroup" style="display: none;">
            <label for="ownerIdentityId">Owner Identity ID (required for Identity-Specific mode):</label>
            <input type="text" id="ownerIdentityId" name="owner_identity_id" placeholder="Enter identity UUID">
          </div>

          <div class="actions">
            <button type="submit" class="btn btn-success">Save</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let clients = [];
      let currentMode = 'global'; // 'global' or 'identity'

      function switchMode() {
        const mode = document.querySelector('input[name="managementMode"]:checked').value;
        currentMode = mode;
        const identityInput = document.getElementById('identityIdInput');
        const ownerIdentityGroup = document.getElementById('ownerIdentityIdGroup');
        const createBtn = document.getElementById('createClientBtn');
        
        if (mode === 'identity') {
          identityInput.style.display = 'block';
          ownerIdentityGroup.style.display = 'block';
          createBtn.textContent = '+ Create Identity Client';
          createBtn.title = 'Create a client for the specified identity (UMS)';
        } else {
          identityInput.style.display = 'none';
          ownerIdentityGroup.style.display = 'none';
          createBtn.textContent = '+ Create Global Client';
          createBtn.title = 'Create a global client (Hydra)';
        }
        
        // Clear and reload clients
        clients = [];
        loadClients();
      }
      
      // Initialize button text on page load
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        switchMode();
      } else {
        document.addEventListener('DOMContentLoaded', switchMode);
      }

      async function loadClients() {
        const container = document.getElementById('clientsList');
        if (!container) {
          console.error('clientsList container not found');
          return;
        }
        container.innerHTML = '<p>Loading clients...</p>';
        
        try {
          let url = '/api/clients';
          if (currentMode === 'identity') {
            const identityId = document.getElementById('identityId').value.trim();
            if (!identityId) {
              container.innerHTML = '<p style="color: #ffc107;">‚ö†Ô∏è Please enter an Identity ID to load identity-specific clients.</p>';
              return;
            }
            url = `/api/identity-clients?identity_id=${encodeURIComponent(identityId)}`;
          }
          
          console.log(`Fetching clients from ${url}...`);
          const response = await fetch(url);
          console.log('Response status:', response.status, response.statusText);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('API error response:', errorText);
            let errorMsg = 'Error loading clients: ' + errorText;
            let isUmsError = false;
            try {
              const errorData = JSON.parse(errorText);
              errorMsg = 'Error loading clients: ' + (errorData.error || errorData.error_description || errorText);
              if (errorData.error && errorData.error.includes('UMS_BASE_URL')) {
                isUmsError = true;
                errorMsg = 'UMS_BASE_URL not configured. Please set it as an environment variable in docker-compose.yml or .env file.';
              }
            } catch (e) {
              // Not JSON, use text as is
              if (errorText.includes('UMS_BASE_URL')) {
                isUmsError = true;
                errorMsg = 'UMS_BASE_URL not configured. Please set it as an environment variable in docker-compose.yml or .env file.';
              }
            }
            showStatus('error', errorMsg);
            if (isUmsError) {
              container.innerHTML = `
                <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; color: #856404;">
                  <h3 style="margin-top: 0;">‚ö†Ô∏è UMS Configuration Required</h3>
                  <p><strong>UMS_BASE_URL</strong> is not configured. To use Identity-Specific Client Management, you need to:</p>
                  <ol>
                    <li>Set <code>UMS_BASE_URL</code> environment variable in <code>docker-compose.yml</code> or create a <code>.env</code> file</li>
                    <li>Restart the container: <code>docker-compose restart oauth-server</code></li>
                  </ol>
                  <p><strong>Example:</strong></p>
                  <pre style="background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto;">UMS_BASE_URL=https://ums.dev.workstream.us</pre>
                  <p style="margin-bottom: 0;">Or use Global Clients (Hydra) mode which doesn't require UMS configuration.</p>
                </div>
              `;
            } else {
              container.innerHTML = '<p style="color: #dc3545;">Failed to load clients. Please check your VPN connection and try again.</p>';
            }
            return;
          }
          
          const data = await response.json();
          console.log('Received data:', data);
          console.log('Data type:', Array.isArray(data) ? 'array' : typeof data);
          console.log('Data length:', Array.isArray(data) ? data.length : 'N/A');
          
          if (data.error) {
            let errorMsg = 'Error loading clients: ' + data.error;
            if (data.error.includes('certificate') || data.error.includes('SSL') || data.error.includes('VPN')) {
              errorMsg += '<br><br>üí° <strong>Tip:</strong> Make sure you are connected to VPN and the Hydra admin endpoint is accessible.';
            }
            showStatus('error', errorMsg);
            container.innerHTML = '<p style="color: #dc3545;">Failed to load clients. Please check your VPN connection and try again.</p>';
            return;
          }

          clients = Array.isArray(data) ? data : [];
          console.log('Clients array length:', clients.length);
          if (clients.length === 0) {
            container.innerHTML = '<p>No clients found. Create your first client!</p>';
          } else {
            console.log('Rendering clients...');
            renderClients();
          }
        } catch (error) {
          console.error('Error loading clients:', error);
          console.error('Error stack:', error.stack);
          showStatus('error', 'Error loading clients: ' + (error.message || 'Unknown error'));
          container.innerHTML = '<p style="color: #dc3545;">Failed to load clients: ' + (error.message || 'Unknown error') + '</p>';
        }
      }

      function renderClients() {
        const container = document.getElementById('clientsList');
        
        if (clients.length === 0) {
          container.innerHTML = '<p>No clients found. Create your first client!</p>';
          return;
        }

        let html = '<table><thead><tr><th>Client ID</th><th>Name</th><th>Grant Types</th><th>Scopes</th><th>Actions</th></tr></thead><tbody>';
        
        clients.forEach(client => {
          const grantTypes = (client.grant_types || []).join(', ') || 'N/A';
          const scopes = client.scope || 'N/A';
          const clientId = client.client_id || client.id || 'N/A';
          const clientName = client.client_name || client.name || 'N/A';
          // Use data attributes instead of onclick to avoid quote escaping issues
          const clientIdAttr = String(clientId).replace(/"/g, '&quot;');
          html += '<tr>' +
            '<td><span class="code">' + clientId + '</span></td>' +
            '<td>' + clientName + '</td>' +
            '<td>' + grantTypes + '</td>' +
            '<td>' + scopes + '</td>' +
            '<td>' +
              '<div class="actions">' +
                '<button class="btn" data-client-id="' + clientIdAttr + '" data-action="edit">Edit</button>' +
                '<button class="btn btn-danger" data-client-id="' + clientIdAttr + '" data-action="delete">Delete</button>' +
              '</div>' +
            '</td>' +
          '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
        // Add event listeners to buttons using event delegation
        container.addEventListener('click', function(e) {
          const button = e.target.closest('button[data-action]');
          if (!button) return;
          
          const clientId = button.getAttribute('data-client-id');
          const action = button.getAttribute('data-action');
          
          if (action === 'edit') {
            editClient(clientId);
          } else if (action === 'delete') {
            deleteClient(clientId);
          }
        });
      }

      function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Create Client';
        document.getElementById('clientForm').reset();
        document.getElementById('clientId').value = '';
        document.getElementById('rt_code').checked = true;
        document.getElementById('gt_client_credentials').checked = true;
        
        // Set owner_identity_id if in identity mode
        if (currentMode === 'identity') {
          const identityId = document.getElementById('identityId').value.trim();
          if (identityId) {
            document.getElementById('ownerIdentityId').value = identityId;
          }
        }
        
        document.getElementById('clientModal').style.display = 'block';
      }

      async function editClient(clientId) {
        const client = clients.find(c => c.client_id === clientId || c.id === clientId);
        if (!client) {
          // Try to fetch the client if not in the list
          try {
            let url = `/api/clients/${clientId}`;
            if (currentMode === 'identity') {
              const identityId = document.getElementById('identityId').value.trim();
              if (!identityId) {
                showStatus('error', 'Identity ID is required for identity-specific mode');
                return;
              }
              url = `/api/identity-clients/${clientId}?identity_id=${encodeURIComponent(identityId)}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
              showStatus('error', 'Client not found');
              return;
            }
            const fetchedClient = await response.json();
            populateEditForm(fetchedClient);
            return;
          } catch (error) {
            showStatus('error', 'Error fetching client: ' + error.message);
            return;
          }
        }
        populateEditForm(client);
      }

      function populateEditForm(client) {
        document.getElementById('modalTitle').textContent = 'Edit Client';
        document.getElementById('clientId').value = client.client_id || client.id || '';
        document.getElementById('clientName').value = client.client_name || client.name || '';
        document.getElementById('scope').value = client.scope || '';
        document.getElementById('redirectUris').value = (client.redirect_uris || []).join('\n');
        document.getElementById('tokenEndpointAuthMethod').value = client.token_endpoint_auth_method || 'client_secret_post';
        
        // Set owner_identity_id if in identity mode
        if (currentMode === 'identity') {
          const identityId = document.getElementById('identityId').value.trim();
          if (identityId) {
            document.getElementById('ownerIdentityId').value = identityId;
          } else if (client.owner_identity_id) {
            document.getElementById('ownerIdentityId').value = client.owner_identity_id;
          }
        }

        // Reset checkboxes
        ['gt_auth_code', 'gt_device_code', 'gt_client_credentials', 'gt_refresh_token'].forEach(id => {
          document.getElementById(id).checked = false;
        });
        ['rt_code'].forEach(id => {
          document.getElementById(id).checked = false;
        });

        // Set grant types
        (client.grant_types || []).forEach(gt => {
          if (gt === 'urn:ietf:params:oauth:grant-type:device_code') {
            document.getElementById('gt_device_code').checked = true;
          } else if (gt === 'authorization_code') {
            document.getElementById('gt_auth_code').checked = true;
          } else if (gt === 'client_credentials') {
            document.getElementById('gt_client_credentials').checked = true;
          } else if (gt === 'refresh_token') {
            document.getElementById('gt_refresh_token').checked = true;
          }
        });

        // Set response types
        (client.response_types || []).forEach(rt => {
          if (rt === 'code') {
            document.getElementById('rt_code').checked = true;
          }
        });

        document.getElementById('clientModal').style.display = 'block';
      }

      function closeModal() {
        document.getElementById('clientModal').style.display = 'none';
      }

      async function saveClient(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const clientId = formData.get('client_id');
        
        // Collect grant types
        const grantTypes = [];
        ['gt_auth_code', 'gt_device_code', 'gt_client_credentials', 'gt_refresh_token'].forEach(id => {
          if (document.getElementById(id).checked) {
            grantTypes.push(document.getElementById(id).value);
          }
        });

        // Collect response types
        const responseTypes = [];
        ['rt_code'].forEach(id => {
          if (document.getElementById(id).checked) {
            responseTypes.push(document.getElementById(id).value);
          }
        });

        // Parse redirect URIs
        const redirectUris = formData.get('redirect_uris')
          .split('\n')
          .map(uri => uri.trim())
          .filter(uri => uri.length > 0);

        const clientData = {
          client_name: formData.get('client_name'),
          grant_types: grantTypes,
          response_types: responseTypes,
          scope: formData.get('scope'),
          redirect_uris: redirectUris,
          token_endpoint_auth_method: formData.get('token_endpoint_auth_method')
        };

        // Add owner_identity_id for identity-specific mode
        if (currentMode === 'identity') {
          const ownerIdentityId = formData.get('owner_identity_id') || document.getElementById('ownerIdentityId')?.value?.trim();
          const identityId = document.getElementById('identityId').value.trim();
          const finalIdentityId = ownerIdentityId || identityId;
          
          if (!finalIdentityId) {
            showStatus('error', 'Identity ID is required for identity-specific mode. Please enter it in the Identity ID field above.');
            return;
          }
          clientData.owner_identity_id = finalIdentityId;
        }

        try {
          let url, method;
          if (currentMode === 'identity') {
            // Identity-specific mode uses UMS endpoints
            if (clientId) {
              const identityId = document.getElementById('identityId').value.trim();
              if (!identityId) {
                showStatus('error', 'Identity ID is required for identity-specific mode');
                return;
              }
              url = `/api/identity-clients/${clientId}?identity_id=${encodeURIComponent(identityId)}`;
              method = 'PUT';
            } else {
              url = '/api/identity-clients';
              method = 'POST';
            }
          } else {
            // Global mode uses Hydra endpoints
            url = clientId ? '/api/clients/' + clientId : '/api/clients';
            method = clientId ? 'PUT' : 'POST';
          }
          
          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
          });

          const data = await response.json();

          if (response.ok) {
            showStatus('success', clientId ? 'Client updated successfully!' : 'Client created successfully!');
            if (data.client_secret) {
              showStatus('info', '‚ö†Ô∏è Client Secret: <span class="secret">' + data.client_secret + '</span> (Save this! It will not be shown again.)');
            }
            closeModal();
            loadClients();
          } else {
            let errorMsg = 'Error: ' + (data.error || data.error_description || data.message || 'Unknown error');
            if (data.details) {
              errorMsg += '<br><br><details><summary>Details</summary><pre style="font-size: 0.85em; margin-top: 10px;">' + JSON.stringify(data.details, null, 2) + '</pre></details>';
            }
            if (data.status) {
              errorMsg += '<br><small>Status: ' + data.status + ' ' + (data.statusText || '') + '</small>';
            }
            showStatus('error', errorMsg);
            console.error('Client creation/update error:', data);
          }
        } catch (error) {
          showStatus('error', 'Error: ' + error.message);
        }
      }

      async function deleteClient(clientId) {
        if (!confirm('Are you sure you want to delete client ' + clientId + '? This action cannot be undone.')) {
          return;
        }

        try {
          let url = `/api/clients/${clientId}`;
          if (currentMode === 'identity') {
            const identityId = document.getElementById('identityId').value.trim();
            if (!identityId) {
              showStatus('error', 'Identity ID is required for identity-specific mode');
              return;
            }
            url = `/api/identity-clients/${clientId}?identity_id=${encodeURIComponent(identityId)}`;
          }
          
          const response = await fetch(url, {
            method: 'DELETE'
          });

          if (response.ok) {
            showStatus('success', 'Client deleted successfully!');
            loadClients();
          } else {
            const data = await response.json();
            showStatus('error', 'Error: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          showStatus('error', 'Error: ' + error.message);
        }
      }

      function showStatus(type, message) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.className = 'status ' + type;
        statusDiv.innerHTML = message;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('clientModal');
        if (event.target === modal) {
          closeModal();
        }
      }

      // Load clients on page load - multiple strategies to ensure it runs
      console.log('‚úÖ Script loaded, readyState:', document.readyState);
      
      // Strategy 1: Call immediately if DOM is ready
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log('‚úÖ DOM ready, calling loadClients immediately');
        setTimeout(() => loadClients(), 100);
      } else {
        console.log('‚è≥ DOM loading, waiting for DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', () => {
          console.log('‚úÖ DOMContentLoaded fired, calling loadClients');
          loadClients();
        });
      }
      
      // Strategy 2: Fallback after window load
      window.addEventListener('load', () => {
        console.log('‚úÖ Window loaded, checking if clients loaded...');
        const container = document.getElementById('clientsList');
        if (container && container.innerHTML.includes('Loading')) {
          console.log('‚ö†Ô∏è Still loading, retrying loadClients');
          loadClients();
        }
      });
      
      // Strategy 3: Final fallback after delay
      setTimeout(() => {
        const container = document.getElementById('clientsList');
        if (container && container.innerHTML.includes('Loading')) {
          console.log('‚ö†Ô∏è Final fallback: Retrying loadClients after 2s');
          loadClients();
        }
      }, 2000);
    </script>
  </body>
</html>

