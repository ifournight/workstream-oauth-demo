<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Device Authorization Flow Demo</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; }
      button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
      button:hover { background: #0056b3; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
      .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
      .status.pending { background: #fff3cd; }
      .status.success { background: #d4edda; }
      .status.error { background: #f8d7da; }
      .status.info { background: #d1ecf1; }
      .user-code { font-size: 24px; font-weight: bold; color: #007bff; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px; margin: 15px 0; }
      .verification-link { font-size: 16px; word-break: break-all; }
      a { color: #007bff; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <h1>Device Authorization Flow Demo</h1>
    <p class="status info">This flow is for devices that cannot securely store client credentials or display a web browser. The user will authorize on a separate device.</p>
    <div class="status" style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; margin: 15px 0;">
      <strong>‚ö†Ô∏è Configuration Limitation:</strong> Device Authorization Flow may not be fully supported due to lack of Ory configuration. Please ensure that your Ory Hydra instance has device flow properly configured before using this flow.
    </div>
    
    <div class="card">
      <h2>Step 1: Request Device & User Codes</h2>
      <p>Click the button below to request device and user codes:</p>
      <p><strong>Client Scopes:</strong> <code><%= clientScopes || "openid offline" %></code></p>
      <p style="font-size: 0.9em; color: #666;">üí° <strong>Note:</strong> These scopes are from your client configuration. Update the client's scope in the <a href="/clients">Client Management</a> page and refresh this page to use new scopes.</p>
      <button id="requestCodeBtn" onclick="requestDeviceCode()">Request Device & User Codes</button>
      <div id="codeResult"></div>
    </div>
    
    <div class="card" id="userAuthCard" style="display: none;">
      <h2>Step 2: User Authorization</h2>
      <p>Please visit the verification URI on another device/browser and enter the user code:</p>
      <div class="user-code" id="userCode"></div>
      <p><strong>Verification URI:</strong></p>
      <p class="verification-link"><a href="#" id="verificationUriLink" target="_blank">Loading...</a></p>
      <p style="font-size: 0.9em; color: #666;">üí° <strong>Tip:</strong> You can also visit the complete verification URI directly (includes user code):</p>
      <p class="verification-link"><a href="#" id="verificationUriComplete" target="_blank">Loading...</a></p>
      <button id="pollBtn" onclick="startPolling()">Start Polling for Token</button>
      <div id="pollStatus"></div>
    </div>
    
    <div class="card" id="tokenResult" style="display: none;">
      <h2>Step 3: Tokens Received</h2>
      <div id="tokenData"></div>
      <div id="tokenInfo"></div>
    </div>
    
    <div class="card" id="apiTestCard" style="display: none;">
      <h2>Step 4: Test API Call</h2>
      <p>Now let's test the API with the access token:</p>
      <button id="testApiBtn" onclick="testAPI()">Test API Call</button>
      <div id="apiResult"></div>
    </div>
    
    <div class="card" id="successCard" style="display: none;">
      <h2>‚úÖ Success!</h2>
      <div id="successContent"></div>
    </div>
    
    <script>
      let deviceCode = '';
      let accessToken = '';
      let interval = 5;
      let pollInterval = null;
      const CLIENT_ID = '<%= clientId %>';
      const CLIENT_SECRET = '<%= clientSecret %>';
      const CLIENT_SCOPES = '<%= clientScopes || "openid offline" %>';
      
      async function requestDeviceCode() {
        const btn = document.getElementById('requestCodeBtn');
        btn.disabled = true;
        btn.textContent = 'Requesting...';
        
        try {
          const response = await fetch('/device/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              client_id: CLIENT_ID,
              client_secret: CLIENT_SECRET,
              scope: CLIENT_SCOPES
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            const errorMsg = data.error_description || data.error || 'Failed to request device code';
            throw new Error(errorMsg);
          }
          
          deviceCode = data.device_code;
          interval = data.interval || 5;
          
          document.getElementById('userCode').textContent = data.user_code;
          const verificationUriLink = document.getElementById('verificationUriLink');
          verificationUriLink.href = data.verification_uri;
          verificationUriLink.textContent = data.verification_uri;
          
          const verificationUriCompleteLink = document.getElementById('verificationUriComplete');
          if (data.verification_uri_complete) {
            verificationUriCompleteLink.href = data.verification_uri_complete;
            verificationUriCompleteLink.textContent = data.verification_uri_complete;
          } else {
            verificationUriCompleteLink.style.display = 'none';
          }
          
          document.getElementById('userAuthCard').style.display = 'block';
          
          document.getElementById('codeResult').innerHTML = 
            '<div class="status success">‚úì Device and user codes received!</div>' +
            '<details><summary>Device Code Response</summary><pre>' + JSON.stringify(data, null, 2) + '</pre></details>';
          
        } catch (error) {
          document.getElementById('codeResult').innerHTML = 
            '<div class="status error">Error: ' + error.message + '</div>';
        } finally {
          btn.disabled = false;
          btn.textContent = 'Request Device & User Codes';
        }
      }
      
      async function startPolling() {
        const pollBtn = document.getElementById('pollBtn');
        pollBtn.disabled = true;
        pollBtn.textContent = 'Polling...';
        
        const statusDiv = document.getElementById('pollStatus');
        statusDiv.innerHTML = '<div class="status pending">Waiting for user authorization...</div>';
        
        let pollCount = 0;
        const maxPolls = 120; // 10 minutes max (assuming 5s interval)
        let currentInterval = interval;
        
        pollInterval = setInterval(async () => {
          try {
            const response = await fetch('/device/poll', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                device_code: deviceCode,
                client_id: CLIENT_ID,
                client_secret: CLIENT_SECRET
              })
            });
            
            const data = await response.json();
            
            if (data.access_token) {
              // Success!
              clearInterval(pollInterval);
              accessToken = data.access_token;
              
              // Display token data
              document.getElementById('tokenData').innerHTML = 
                '<div class="status success">‚úì Authorization complete! Tokens received.</div>' +
                '<details><summary>Token Response</summary><pre>' + JSON.stringify(data, null, 2) + '</pre></details>';
              
              document.getElementById('tokenResult').style.display = 'block';
              statusDiv.innerHTML = '<div class="status success">‚úì Authorization complete! Tokens received.</div>';
              pollBtn.textContent = 'Polling Complete';
              pollBtn.disabled = true;
              
              // Show API test card
              document.getElementById('apiTestCard').style.display = 'block';
            } else if (data.error === 'authorization_pending') {
              pollCount++;
              statusDiv.innerHTML = '<div class="status pending">Still waiting for authorization... (Poll ' + pollCount + ')</div>';
            } else if (data.error === 'slow_down') {
              currentInterval += 5;
              statusDiv.innerHTML = '<div class="status pending">Slow down requested. Increasing polling interval to ' + currentInterval + 's...</div>';
            } else if (data.error === 'expired_token') {
              clearInterval(pollInterval);
              statusDiv.innerHTML = '<div class="status error">Device code expired. Please start over.</div>';
              pollBtn.disabled = false;
              pollBtn.textContent = 'Start Polling for Token';
            } else {
              clearInterval(pollInterval);
              statusDiv.innerHTML = '<div class="status error">Error: ' + (data.error_description || data.error) + '</div>';
              pollBtn.disabled = false;
              pollBtn.textContent = 'Start Polling for Token';
            }
            
            if (pollCount >= maxPolls) {
              clearInterval(pollInterval);
              statusDiv.innerHTML = '<div class="status error">Timeout: Maximum polling attempts reached. Please start over.</div>';
              pollBtn.disabled = false;
              pollBtn.textContent = 'Start Polling for Token';
            }
          } catch (error) {
            clearInterval(pollInterval);
            statusDiv.innerHTML = '<div class="status error">Error: ' + error.message + '</div>';
            pollBtn.disabled = false;
            pollBtn.textContent = 'Start Polling for Token';
          }
        }, currentInterval * 1000);
      }
      
      async function testAPI() {
        const btn = document.getElementById('testApiBtn');
        btn.disabled = true;
        btn.textContent = 'Testing...';
        
        try {
          const response = await fetch('/device/test-api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              access_token: accessToken
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            let tokenInfoHtml = '';
            if (data.tokenInfo) {
              // For Device Flow, sub should be the user identity (like Authorization Code Flow)
              tokenInfoHtml = '<div class="card" style="margin-top: 15px; background: #f8f9fa;"><h3>Token Information (from JWT):</h3>' +
                '<p><strong>Scopes:</strong> <code>' + (data.tokenInfo.scopes || 'N/A') + '</code></p>' +
                '<p><strong>Audience:</strong> <code>' + (typeof data.tokenInfo.audience === 'object' ? JSON.stringify(data.tokenInfo.audience) : data.tokenInfo.audience) + '</code></p>' +
                '<p><strong>Subject (sub):</strong> <code>' + (data.tokenInfo.subject || 'N/A') + '</code></p>' +
                '<p style="font-size: 0.85em; color: #28a745; margin-top: 5px;">‚úÖ <strong>Note:</strong> In Device Flow, <code>sub</code> should be the user identity (Ory Kratos identity ID), not the client ID.</p>' +
                '<p><strong>Client ID (from token):</strong> <code>' + (data.tokenInfo.clientId || 'N/A') + '</code></p>' +
                '<p><strong>Expires At:</strong> <code>' + (data.tokenInfo.expiresAt || 'N/A') + '</code></p>' +
                '<p><strong>Issued At:</strong> <code>' + (data.tokenInfo.issuedAt || 'N/A') + '</code></p>' +
                '</div>';
            }
            
            document.getElementById('apiResult').innerHTML = 
              '<div class="status success">‚úÖ External API call successful! Authentication is working.</div>' +
              '<p><strong>External API:</strong> ' + (data.apiUrl || 'http://localhost:3392/v2/public/managers/time_entries?...') + '</p>' +
              '<p><strong>Response Time:</strong> ' + (data.duration || 'N/A') + '</p>' +
              tokenInfoHtml +
              '<details><summary>API Response</summary><pre>' + JSON.stringify(data.data, null, 2) + '</pre></details>';
            
            document.getElementById('successCard').style.display = 'block';
            let curlCommandsHtml = '';
            if (data.curlCommand) {
              curlCommandsHtml += '<h3>cURL Command (Direct API Call):</h3>' +
                '<pre>' + data.curlCommand + '</pre>';
            }
            if (data.testApiCurlCommand) {
              curlCommandsHtml += '<h3>cURL Command (via Test API Endpoint):</h3>' +
                '<pre>' + data.testApiCurlCommand + '</pre>';
            }
            
            document.getElementById('successContent').innerHTML = 
              '<p><strong>Status:</strong> ' + data.status + ' ' + data.statusText + '</p>' +
              '<p><strong>External API:</strong> ' + (data.apiUrl || 'http://localhost:3392/v2/public/managers/time_entries?...') + '</p>' +
              '<p><strong>Result:</strong> Device Authorization Flow is working correctly!</p>' +
              curlCommandsHtml;
          } else {
            let errorMsg = '‚ùå External API call failed: ' + (data.error || 'Unknown error');
            if (data.status === 401) {
              errorMsg += '<br><br>üí° <strong>Important:</strong> The external API call WAS made from the server to <code>' + (data.apiUrl || 'http://localhost:3392/v2/public/managers/time_entries?...') + '</code>, but returned 401 Unauthorized.';
              errorMsg += '<br><br><strong>Possible reasons:</strong><ul style="margin-top: 10px;"><li>Token scopes may not match what the API requires</li><li>Token audience may not include the API endpoint</li><li>API may require additional permissions/claims</li></ul>';
            } else {
              errorMsg += '<br><br>üí° <strong>Note:</strong> The server made an external API call to <code>' + (data.apiUrl || 'http://localhost:3392/v2/public/managers/time_entries?...') + '</code>. You won\'t see this call in the browser\'s Network tab because it happens server-side.';
            }
            
            let tokenInfoHtml = '';
            if (data.tokenInfo) {
              tokenInfoHtml = '<div class="card" style="margin-top: 15px; background: #f8f9fa;"><h3>Token Information (from JWT):</h3>' +
                '<p><strong>Scopes:</strong> <code>' + (data.tokenInfo.scopes || 'N/A') + '</code></p>' +
                '<p><strong>Audience:</strong> <code>' + (typeof data.tokenInfo.audience === 'object' ? JSON.stringify(data.tokenInfo.audience) : data.tokenInfo.audience) + '</code></p>' +
                '<p><strong>Subject (sub):</strong> <code>' + (data.tokenInfo.subject || 'N/A') + '</code></p>' +
                '<p><strong>Client ID (from token):</strong> <code>' + (data.tokenInfo.clientId || 'N/A') + '</code></p>' +
                '<p><strong>Expires At:</strong> <code>' + (data.tokenInfo.expiresAt || 'N/A') + '</code></p>' +
                '<p><strong>Issued At:</strong> <code>' + (data.tokenInfo.issuedAt || 'N/A') + '</code></p>' +
                '</div>';
            }
            
            let curlCommandsHtml = '';
            if (data.curlCommand) {
              curlCommandsHtml += '<h3>cURL Command (Direct API Call):</h3>' +
                '<pre>' + data.curlCommand + '</pre>';
            }
            if (data.testApiCurlCommand) {
              curlCommandsHtml += '<h3>cURL Command (via Test API Endpoint):</h3>' +
                '<pre>' + data.testApiCurlCommand + '</pre>';
            }
            
            document.getElementById('apiResult').innerHTML = 
              '<div class="status error">' + errorMsg + '</div>' +
              '<p><strong>External API:</strong> ' + (data.apiUrl || 'http://localhost:3392/v2/public/managers/time_entries?...') + '</p>' +
              '<p><strong>Status:</strong> ' + data.status + ' ' + data.statusText + '</p>' +
              '<p><strong>Response Time:</strong> ' + (data.duration || 'N/A') + '</p>' +
              tokenInfoHtml +
              curlCommandsHtml +
              (data.errorMessage ? '<p><strong>Error:</strong> ' + data.errorMessage + '</p>' : '') +
              (data.errorDetails ? '<details><summary>API Response Details</summary><pre>' + data.errorDetails + '</pre></details>' : '');
          }
        } catch (error) {
          document.getElementById('apiResult').innerHTML = 
            '<div class="status error">Error: ' + error.message + '</div>';
        } finally {
          btn.disabled = false;
          btn.textContent = 'Test API Call';
        }
      }
    </script>
  </body>
</html>

