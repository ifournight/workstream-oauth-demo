# 如何获取访问令牌

本指南说明如何通过 UMS API 使用您的 OAuth 客户端凭据获取访问令牌。

## 前置要求

- 有效的 `client_id` 和 `client_secret`（从[创建客户端](./create-client)获得）
- UMS API 基础 URL

## API 端点

**端点**: `POST /auth/v1/oauth-apps/token`

**基础 URL**: <EnvVar name="UMS_BASE_URL" />

**完整 URL**: <EnvVar name="UMS_BASE_URL" />/auth/v1/oauth-apps/token

## 请求格式

### 请求头

```
Content-Type: application/json
```

### 请求体

请求体应以 `application/json` 格式发送，包含以下字段：

```json
{
  "client_id": "your-client-id",
  "client_secret": "your-client-secret"
}
```

**必需字段：**
- `client_id`: 您的 OAuth 客户端 ID（必需）
- `client_secret`: 您的 OAuth 客户端密钥（必需）

## 响应格式

### 成功响应

```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIs...",
  "token_type": "bearer",
  "expires_in": 3600
}
```

### 错误响应

```json
{
  "error": "invalid_client",
  "error_description": "客户端身份验证失败"
}
```

## 代码示例

### JavaScript/TypeScript (Fetch API)

```typescript
async function getToken(clientId: string, clientSecret: string): Promise<string> {
  const umsBaseUrl = process.env.UMS_BASE_URL || 'https://ums.example.com';

  const response = await fetch(`${umsBaseUrl}/auth/v1/oauth-apps/token`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      client_id: clientId,
      client_secret: clientSecret,
    }),
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(`获取令牌失败: ${error.error || response.statusText}`);
  }
  
  const data = await response.json();
  return data.access_token;
}

// 使用示例
try {
  const token = await getToken('your-client-id', 'your-client-secret');
  console.log('访问令牌:', token);
  
  // 使用令牌进行经过身份验证的 API 调用
  const apiResponse = await fetch('https://api.example.com/data', {
    headers: {
      'Authorization': `Bearer ${token}`,
    },
  });
} catch (error) {
  console.error('错误:', error);
}
```

### Python (requests 库)

```python
import requests
import os

def get_token(client_id: str, client_secret: str) -> str:
    """通过 UMS API 使用客户端凭据获取 OAuth 访问令牌。"""
    ums_base_url = os.getenv('UMS_BASE_URL', 'https://ums.example.com')
    response = requests.post(
        f'{ums_base_url}/auth/v1/oauth-apps/token',
        json={
            'client_id': client_id,
            'client_secret': client_secret,
        },
        headers={'Content-Type': 'application/json'}
    )
    response.raise_for_status()
    data = response.json()
    return data['access_token']

# 使用示例
try:
    token = get_token('your-client-id', 'your-client-secret')
    print(f'访问令牌: {token}')
    
    # 使用令牌进行经过身份验证的 API 调用
    api_response = requests.get(
        'https://api.example.com/data',
        headers={'Authorization': f'Bearer {token}'}
    )
    api_response.raise_for_status()
except requests.exceptions.RequestException as e:
    print(f'错误: {e}')
```

### cURL

```bash
# 获取令牌
# 将 <UMS_BASE_URL> 替换为您的实际 UMS 基础 URL（例如：https://ums.example.com）
UMS_BASE_URL="<UMS_BASE_URL>"
curl -X POST "${UMS_BASE_URL}/auth/v1/oauth-apps/token" \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "your-client-id",
    "client_secret": "your-client-secret"
  }'

# 在 API 调用中使用令牌
TOKEN=$(curl -s -X POST "${UMS_BASE_URL}/auth/v1/oauth-apps/token" \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "your-client-id",
    "client_secret": "your-client-secret"
  }' | jq -r '.access_token')

curl -H "Authorization: Bearer $TOKEN" \
  https://api.example.com/data
```

### Node.js (原生 HTTP/HTTPS)

```javascript
const https = require('https');

function getToken(clientId, clientSecret) {
  return new Promise((resolve, reject) => {
    const umsBaseUrl = process.env.UMS_BASE_URL || 'https://ums.example.com';
    const url = new URL('/auth/v1/oauth-apps/token', umsBaseUrl);
    
    const data = JSON.stringify({
      client_id: clientId,
      client_secret: clientSecret,
    });

    const options = {
      hostname: url.hostname,
      path: url.pathname,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': data.length,
      },
    };

    const req = https.request(options, (res) => {
      let responseData = '';

      res.on('data', (chunk) => {
        responseData += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 200) {
          const result = JSON.parse(responseData);
          resolve(result.access_token);
        } else {
          reject(new Error(`失败: ${res.statusCode} ${responseData}`));
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.write(data);
    req.end();
  });
}

// 使用
getToken('your-client-id', 'your-client-secret')
  .then(token => {
    console.log('访问令牌:', token);
  })
  .catch(error => {
    console.error('错误:', error);
  });
```

## 错误处理

常见错误场景：

### 无效的客户端凭据

```json
{
  "error": "invalid_client",
  "error_description": "客户端身份验证失败"
}
```

**解决方案**：验证您的 `client_id` 和 `client_secret` 是否正确。

### 缺少参数

```json
{
  "error": "invalid_request",
  "error_description": "client_id is required"
}
```

**解决方案**：确保请求体中包含 `client_id` 和 `client_secret`。

## 使用访问令牌

获得访问令牌后，在 API 请求的 `Authorization` 请求头中包含它：

```
Authorization: Bearer <access_token>
```

### API 调用示例

```javascript
const response = await fetch('https://api.example.com/protected-resource', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
});
```

## 令牌过期

访问令牌通常在特定时间后过期（例如，3600 秒 / 1 小时）。您需要：

1. 监控令牌过期时间
2. 在过期前请求新令牌
3. 通过刷新令牌处理 401 未授权响应

## 注意事项

- 此端点直接使用 UMS API
- 安全存储令牌，切勿在客户端代码中暴露它们
- 令牌是承载令牌 - 任何拥有令牌的人都可以使用它
- 进行令牌请求时始终使用 HTTPS

## 下一步

- 了解令牌刷新机制
- 探索接受这些令牌的 API 端点
- 在您的应用程序中实现令牌缓存和刷新逻辑
